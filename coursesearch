#!/usr/bin/env python3
# Help derived from https://docs.python.org/3/library/html.parser.html

# Authored by Sahejveer, Tristan, Ali & Kyler

import os
from re import search
import sys
import json
import argparse

INPUT_FILE = 'data/results.json'
NAME_MAPPING_FILE = 'data/course_mapping.json'

SECTION_INFO = {
    'courseName': 'Course Name',
    'faculty': 'Instructor',
    'term': 'Term',
    'open': 'Status',
    'location': 'Location',
    'available': 'Available Spots',
    'capacity': 'Capacity',
    'credits': 'Credits',
    'academicLevel': 'Academic Level'
}

MEETING_INFO = ['meeting_type', 'meeting_day', 'start_time', 'end_time', 'building', 'room']

def usage():
	print('Usage: coursesearch <course_code|course_name> [--in input_file.json]')

# python3 coursesearch.py [args..]
# coursesearch CIS3760
# coursesearch --help

if len(sys.argv) != 2:
	if len(sys.argv) == 4 and sys.argv[2] == '--in':
		INPUT_FILE = sys.argv[3]
	else:
		usage()
		sys.exit()

if sys.argv[1] == '-h' or sys.argv[1] == '--help':
	usage()
	sys.exit()

# check for existence of input file
if not os.path.exists(INPUT_FILE):
    print('coursesearch: input file does not exist')
    sys.exit()

# assign searched value to a variable
search_course = sys.argv[1]

file = open(INPUT_FILE)
course_data = json.load(file) # load json data in dictionary

mapping_file = open(NAME_MAPPING_FILE)
course_mapping = json.load(mapping_file) # load secondary json dictionary with course names as the key


exit_cond = 0   
while exit_cond == 0:
    if search_course.upper() in course_mapping:
        search_course = course_mapping[search_course.upper()]

    if search_course.upper() in course_data:
        course = course_data[search_course.upper()]
        course_code = course[0]['department'] + course[0]['courseCode']
    
        print("Course: " + course_code + "\n")

        # print each section
        for i in range(len(course)):
            section = course[i]

            print("Section: ", section['section'])

            # print each key we want to display from SECTION_INFO
            for key, title in SECTION_INFO.items():
                # ensure that the key exists in the course dictionary
                if key in section and section[key]:
                    print("" + title + ": ", section[key])

            # ensure meetings exist and is non-empty
            if 'meeting' in section and section['meeting']:
                print("Meeting Info:")
                for meeting in section['meeting']:
                    # ensure all meeting data is present
                    if all(key in meeting for key in MEETING_INFO):
                        print("\t(" + meeting['meeting_type'] + ") " + meeting['meeting_day'] + " " + meeting['start_time'] + " - " + meeting['end_time'] + ", " + meeting['building'] + " " + meeting['room'])
            print("\n")
    else:
        print("coursesearch: Course does not exist")


    # looping to search multiple times before exiting.
    search_course = input("Would you like to search for another course? (Yes, No) ")
    if search_course.upper() == "YES":
        search_course = input("Enter a course:")
    elif search_course.upper() == "NO":
        exit_cond = 1

